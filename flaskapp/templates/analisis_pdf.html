<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{{ title or "Informe de análisis" }}</title>
  <style>
    @page {
      size: A4;
      margin: 20mm;
    }

    body {
      font-family: "DejaVu Sans", Arial, sans-serif;
      font-size: 12px;
      color: #333;
    }

    .header {
      border-bottom: 2px solid #0d6efd;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    .header h1 {
      margin: 0;
      font-size: 22px;
      color: #0d6efd;
    }

    .header .subtitle {
      margin-top: 4px;
      font-size: 12px;
      color: #555;
    }

    .section {
      margin-bottom: 18px;
    }

    .section h2 {
      margin: 0 0 6px 0;
      font-size: 16px;
      color: #0d6efd;
      border-bottom: 1px solid #ccc;
      padding-bottom: 3px;
    }

    .meta-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
    }

    .meta-table td {
      padding: 3px 4px;
      vertical-align: top;
    }

    .meta-label {
      font-weight: bold;
      width: 140px;
      white-space: nowrap;
    }

    table.data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;
    }

    table.data-table th,
    table.data-table td {
      border: 1px solid #ccc;
      padding: 4px 6px;
    }

    table.data-table th {
      background-color: #f2f2f2;
      font-weight: bold;
      text-align: left;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: bold;
      color: #fff;
    }

    .badge-critical {
      background-color: #dc3545; /* rojo crítico */
    }

    .badge-high {
      background-color: #dc3545; /* también rojo para HIGH */
    }

    .badge-medium {
      background-color: #ffc107; /* amarillo */
      color: #000;
    }

    .badge-low {
      background-color: #0dcaf0; /* celeste */
      color: #000;
    }

    .badge-other {
      background-color: #6c757d; /* gris */
    }

    ul.recomendaciones {
      margin: 4px 0 0 18px;
      padding: 0;
    }

    ul.recomendaciones li {
      margin-bottom: 3px;
    }

    .small-muted {
      font-size: 10px;
      color: #666;
    }
  </style>
</head>
<body>

{# ===== PRE-CÁLCULOS (hosts y severidades) ===== #}
{% set ns = namespace(hosts=[], critical=0, high=0, medium=0, low=0, other=0) %}

{# Hosts únicos #}
{% for p in scan.open_ports or [] %}
  {% if p["host"] is defined and p["host"] not in ns.hosts %}
    {% set ns.hosts = ns.hosts + [p["host"]] %}
  {% endif %}
{% endfor %}

{# Conteo de severidades #}
{% for v in scan.vulnerabilities or [] %}
  {% set sev = (v["severity"] or "")|lower %}
  {% if sev == "critical" %}
    {% set ns.critical = ns.critical + 1 %}
  {% elif sev == "high" %}
    {% set ns.high = ns.high + 1 %}
  {% elif sev == "medium" %}
    {% set ns.medium = ns.medium + 1 %}
  {% elif sev == "low" %}
    {% set ns.low = ns.low + 1 %}
  {% else %}
    {% set ns.other = ns.other + 1 %}
  {% endif %}
{% endfor %}


<!-- ================= CABECERA ================= -->
<div class="header">
  <h1>Informe de análisis de seguridad</h1>
  <div class="subtitle">
    Empresa: <strong>{{ company.name }}</strong>
    &nbsp;·&nbsp; CIF: {{ company.cif }}<br>
    Fecha del análisis: {{ scan.created_at.strftime("%d/%m/%Y %H:%M") }}
  </div>
</div>


<!-- ============== 1. RESUMEN GENERAL ============== -->
<div class="section">
  <h2>1. Resumen general</h2>

  <table class="meta-table">
    <tr>
      <td class="meta-label">Fecha del análisis:</td>
      <td>{{ scan.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
    </tr>
    <tr>
      <td class="meta-label">Máquinas detectadas:</td>
      <td>{{ ns.hosts|length }}</td>
    </tr>
    <tr>
      <td class="meta-label">Puertos abiertos:</td>
      <td>{{ (scan.open_ports or [])|length }}</td>
    </tr>
    <tr>
      <td class="meta-label">Vulnerabilidades totales:</td>
      <td>{{ (scan.vulnerabilities or [])|length }}</td>
    </tr>
  </table>

  <p style="margin-top: 8px;"><strong>Severidades detectadas:</strong></p>
  <table class="meta-table">
    <tr>
      <td class="meta-label">Críticas (CRITICAL):</td>
      <td><span class="badge badge-critical">{{ ns.critical }}</span></td>
    </tr>
    <tr>
      <td class="meta-label">Altas (HIGH):</td>
      <td><span class="badge badge-high">{{ ns.high }}</span></td>
    </tr>
    <tr>
      <td class="meta-label">Medias (MEDIUM):</td>
      <td><span class="badge badge-medium">{{ ns.medium }}</span></td>
    </tr>
    <tr>
      <td class="meta-label">Bajas (LOW):</td>
      <td><span class="badge badge-low">{{ ns.low }}</span></td>
    </tr>
    <tr>
      <td class="meta-label">Otras:</td>
      <td><span class="badge badge-other">{{ ns.other }}</span></td>
    </tr>
  </table>
</div>


<!-- ============== 2. PUERTOS ABIERTOS ============== -->
<div class="section">
  <h2>2. Puertos abiertos detectados</h2>

  {% if scan.open_ports %}
    <table class="data-table">
      <thead>
        <tr>
          <th style="width:35%;">Host</th>
          <th style="width:15%;">Puerto</th>
          <th style="width:50%;">Servicio</th>
        </tr>
      </thead>
      <tbody>
        {% for p in scan.open_ports %}
        <tr>
          <td>{{ p["host"] }}</td>
          <td>{{ p["port"] }}</td>
          <td>{{ p["service"] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="small-muted">No se han registrado puertos abiertos en este análisis.</p>
  {% endif %}
</div>


<!-- ============== 3. VULNERABILIDADES ============== -->
<div class="section">
  <h2>3. Vulnerabilidades identificadas</h2>

  {% if scan.vulnerabilities %}
    <table class="data-table">
      <thead>
        <tr>
          <th style="width:12%;">Severidad</th>
          <th style="width:28%;">Host:Puerto</th>
          <th style="width:60%;">Descripción</th>
        </tr>
      </thead>
      <tbody>
        {% for v in scan.vulnerabilities %}
          {% set sev = (v["severity"] or "")|lower %}
          {% if sev == "critical" %}
            {% set sev_label = "CRITICAL" %}
            {% set sev_class = "badge-critical" %}
          {% elif sev == "high" %}
            {% set sev_label = "HIGH" %}
            {% set sev_class = "badge-high" %}
          {% elif sev == "medium" %}
            {% set sev_label = "MEDIUM" %}
            {% set sev_class = "badge-medium" %}
          {% elif sev == "low" %}
            {% set sev_label = "LOW" %}
            {% set sev_class = "badge-low" %}
          {% else %}
            {% set sev_label = sev|upper %}
            {% set sev_class = "badge-other" %}
          {% endif %}

          <tr>
            <td>
              <span class="badge {{ sev_class }}">{{ sev_label }}</span>
            </td>
            <td>
              {{ v.get("host", "") }}{% if v.get("port") %}:{{ v.get("port") }}{% endif %}
            </td>
            <td>{{ v["description"] }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="small-muted">No se han detectado vulnerabilidades en este análisis.</p>
  {% endif %}
</div>


<!-- ============== 4. RECOMENDACIONES ============== -->
<div class="section">
  <h2>4. Recomendaciones</h2>

  <ul class="recomendaciones">
    {% if ns.critical > 0 %}
      <li>
        Existen vulnerabilidades de severidad <strong>CRITICAL</strong>.  
        Se recomienda su corrección inmediata (aplicación de parches, desactivación de servicios,
        refuerzo de contraseñas, segmentación de red, etc.).
      </li>
    {% endif %}

    {% if (scan.open_ports or [])|length > 10 %}
      <li>
        Se ha detectado un número elevado de puertos abiertos.  
        Revise las reglas del cortafuegos y limite la exposición únicamente a los servicios imprescindibles.
      </li>
    {% endif %}

    {% if 'http' in (scan.open_ports | map(attribute='service') | list if scan.open_ports else []) %}
      <li>
        Se ha identificado tráfico HTTP sin cifrar.  
        Se recomienda migrar los servicios a <strong>HTTPS</strong> para proteger la confidencialidad de la información.
      </li>
    {% endif %}

    <li>
      Realice análisis de seguridad de forma periódica (mensual o trimestral) y
      registre la evolución para comprobar la mejora del nivel de seguridad.
    </li>

    <li>
      Combine estos resultados con otros controles (inventario de activos, gestión de parches,
      revisión de contraseñas y accesos) para una visión global del riesgo.
    </li>
  </ul>
</div>

</body>
</html>
